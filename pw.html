<html>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
<script src="json2.js"></script>
<script type="text/javascript" src="jquery.autolink.js"></script>
<script type="text/javascript" src="RollCake.js"></script>
<script type="text/javascript">
(function($){
	$(document).ready(function(){ 
		//$('body').append('<span id="sound"></span>');
		/*
		var messageReceiveInnotation = function(){
			var url = 'tm2_switch001.wav';
			document.getElementById("#sound").innerHTML="<embed src='"+url+"' hidden=true autostart=true loop=false>";
		}
		*/
        var con = RollCake.rcpConnection();
        var Pass = function(){return True;};
		var onReceive = function(raw_cmd_str, cmd){
			$('#debug_log').prepend('<div class = "msg">'+RollCake.timeStr()+raw_cmd_str+'</div>');

			if (cmd.command === 'appendValue'){
				//messageReceiveInnotation();
				$('#result').prepend('<div class = "msg">'+cmd.value.time+':'+cmd.value.handlename+":"+cmd.value.message+'</div>');
				$('#result').autolink();
			}
			else if (cmd.command === 'caution'){
				if(cmd.cause === 'logintUser'){
					$('#login_result').val() = 'failure.';
				}
			}
			else if (cmd.command === 'info'){
				if(cmd.cause === 'loginUser'){
					//$('#login_create').hide();
					$('#handlename').text($('#username').val());
				}
			}
			else if (cmd.command === 'addUser'){
				$('#result').prepend('<div class = "msg">'+cmd.username+' login.'+'</div>');
				$('#online_user_list').prepend('<span class="user_id_'+cmd.username+'">'+cmd.username+' </span>');
			}	
			else if (cmd.command === 'removeUser'){
				$('#result').prepend('<div class = "msg">'+cmd.username+' logout.'+'</div>');
				$('.user_id_'+cmd.username).remove();
			}

		}
		//var host_address = "192.168.11.27"
		var host_address = "www.tuna-cat.com"
        con.connectToServer(host_address,4001,Pass,Pass,onReceive,Pass);
       

        $('#createUser_button').click(function(){
			con.createUser($('#username').val(), $('#password').val());
			$('#message_text').val("");
        });
        
		$('#login_button').click(function(){
			con.loginUser($('#username').val(), $('#password').val(), 'pw');
			$('#message_text').val("");
        });
		
		$('#addPermission_button').click(function(){
			con.addPermission($('#username').val());
			$('#message_text').val("");
        });

		var send_message = function(){
			/*	
			if (!$.trim($('#message_text'.val())))
			{
				$('#debug_log').prepend('message is none.');
				return;	
			}
			else
			*/
			{	
				cmd = {
					command:'appendValue',
					value:{
						handlename:$('#handlename').val(),
						message:$('#message_text').val(),
						time:RollCake.timeStr()
					}
				}
				con.sendCommand(cmd);
				$('#message_text').val("");
			}
        }

        $('#send_button').click(function(){
			/*	
			if (!$.trim($('#message_text'.val())))
			{
				$('#debug_log').prepend('message is none.');
				return;	
			}
			else
			*/
			{	
				cmd = {
					command:'appendValue',
					value:{
						handlename:$('#handlename').val(),
						message:$('#message_text').val(),
						time:RollCake.timeStr()
					}
				}
				con.sendCommand(cmd);
				$('#message_text').val("");
			}
        })
		
		$('#message_text').keyup(function(e){
			if (e.keyCode === 13 && e.shiftKey){ // Shift + Enter
				$('#send_button').click();
			}
		})
		
		$('#password').keyup(function(e){
			if (e.keyCode === 13){ // Enter
				$('#login_button').click();
			}
		})
        
    });

})(jQuery);
</script>
<head>
<title>test</title>
</head>
<body>
<div>online user: <span id="online_user_list"></span></div>
<div id="login_and_create">
	<table>
		<tr><td>name:</td><td><input type="text" id="username"></td></tr><br />
		<tr><td>pass:</td><td><input type="password" id="password">
			<button id="login_button">login</button>
			<button id="createUser_button">create</button>
			<!--<button id="addPermission_button">add permission</button>-->
			<br />
		</td></tr>
	</table>
</div>
<div id="login_result"></div><br />
<br />
<input type="text" id="handlename"><br />
<textarea id="message_text" width=></textarea>
<button id="send_button">send(shift+enter)</button>
<div id="result"></div><br />
<div id="debug_log"></div>
</body>
</html>
